<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="kubernetes_Service">
<meta property="og:url" content="https://www.buhuixiu.com/2021/11/08/service/">
<meta property="og:site_name" content="Sampson&#39;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.buhuixiu.com/2021/11/08/service/20211108120823314.png">
<meta property="og:image" content="https://www.buhuixiu.com/2021/11/08/service/20211108025250483.png">
<meta property="og:image" content="https://www.buhuixiu.com/2021/11/08/service/20211108025354880.png">
<meta property="og:image" content="https://www.buhuixiu.com/2021/11/08/service/20211110054907153.png">
<meta property="og:image" content="https://www.buhuixiu.com/2021/11/08/service/20211110055857455.png">
<meta property="og:image" content="https://www.buhuixiu.com/2021/11/08/service/20211110055935543.png">
<meta property="og:image" content="https://www.buhuixiu.com/2021/11/08/service/20211110060503808.png">
<meta property="og:image" content="https://www.buhuixiu.com/2021/11/08/service/20211110060632133.png">
<meta property="article:published_time" content="2021-11-08T03:24:01.000Z">
<meta property="article:modified_time" content="2021-11-08T03:24:01.000Z">
<meta property="article:author" content="Sampson.Z">
<meta property="article:tag" content="K8S">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.buhuixiu.com/2021/11/08/service/20211108120823314.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>kubernetes_Service</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/zhuxinkai.site/">zhuxinkai.site</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇 " href="/2021/11/08/Pod%E4%B8%8EService%E7%9A%84DNS/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇 " href="/2021/10/19/Gartner2020%E5%B9%B4%E5%8D%81%E5%A4%A7%E5%AE%89%E5%85%A8%E9%A1%B9%E7%9B%AE%E8%AF%A6%E8%A7%A3/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部 " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章 " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.buhuixiu.com/2021/11/08/service/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.buhuixiu.com/2021/11/08/service/&text=kubernetes_Service"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.buhuixiu.com/2021/11/08/service/&is_video=false&description=kubernetes_Service"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=kubernetes_Service&body=Check out this article: https://www.buhuixiu.com/2021/11/08/service/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.buhuixiu.com/2021/11/08/service/&name=kubernetes_Service&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.buhuixiu.com/2021/11/08/service/&t=kubernetes_Service"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89%E9%80%89%E6%8B%A9%E7%AC%A6%E7%9A%84Service"><span class="toc-number">1.</span> <span class="toc-text">没有选择符的Service</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F-IP-%E5%92%8C-Service-%E4%BB%A3%E7%90%86"><span class="toc-number"></span> <span class="toc-text">虚拟 IP 和 Service 代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#userspace-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">userspace 代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">iptables 代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPVS-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">IPVS 代理模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E7%AB%AF%E5%8F%A3Service"><span class="toc-number"></span> <span class="toc-text">多端口Service</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E8%87%AA%E5%B7%B1%E7%9A%84IP%E5%9C%B0%E5%9D%80"><span class="toc-number"></span> <span class="toc-text">选择自己的IP地址</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%9C%BA%E6%99%AF"><span class="toc-number">0.0.0.1.</span> <span class="toc-text">需求场景:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%EF%BC%9A"><span class="toc-number">0.0.0.2.</span> <span class="toc-text">条件：</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E7%AD%96%E7%95%A5"><span class="toc-number"></span> <span class="toc-text">流量策略</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number"></span> <span class="toc-text">服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.</span> <span class="toc-text">环境变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS"><span class="toc-number">1.1.</span> <span class="toc-text">DNS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1-%E3%80%90Headless-Services%E3%80%91"><span class="toc-number"></span> <span class="toc-text">无头服务 【Headless Services】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="toc-number">0.1.</span> <span class="toc-text">无头服务测试：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81dns%E6%96%B9%E5%BC%8F%E8%B4%9F%E8%BD%BD%E7%9A%84headless-Services"><span class="toc-number">0.2.</span> <span class="toc-text">验证dns方式负载的headless Services.</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%A6%E9%80%89%E6%8B%A9%E7%AE%97%E7%AC%A6%E7%9A%84%E6%9C%8D%E5%8A%A1-%E3%80%90ClusterIP-NodePort-LoadBalancer-ExternalName%E3%80%91"><span class="toc-number">0.2.0.1.</span> <span class="toc-text">带选择算符的服务 【ClusterIP , NodePort , LoadBalancer, ExternalName】</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E9%80%89%E6%8B%A9%E7%AE%97%E7%AC%A6%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">0.2.0.2.</span> <span class="toc-text">无选择算符的服务</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1%EF%BC%88%E6%9C%8D%E5%8A%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number"></span> <span class="toc-text">发布服务（服务类型)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes-ServiceTypes-%E5%85%81%E8%AE%B8%E6%8C%87%E5%AE%9A%E4%BD%A0%E6%89%80%E9%9C%80%E8%A6%81%E7%9A%84-Service-%E7%B1%BB%E5%9E%8B%EF%BC%8C%E9%BB%98%E8%AE%A4%E6%98%AF-ClusterIP%E3%80%82"><span class="toc-number">0.0.1.</span> <span class="toc-text">Kubernetes ServiceTypes 允许指定你所需要的 Service 类型，默认是 ClusterIP。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NodePort-%E7%B1%BB%E5%9E%8B"><span class="toc-number">0.0.2.</span> <span class="toc-text">NodePort 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LoadBalancer-%E7%B1%BB%E5%9E%8B"><span class="toc-number">0.0.3.</span> <span class="toc-text">LoadBalancer 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ExternalName-%E7%B1%BB%E5%9E%8B-%E5%81%9A%E4%BA%86%E4%B8%80%E4%B8%AADNS%E5%88%AB%E5%90%8D%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%94%A8%E4%BA%8E%E6%8A%8A%E5%A4%96%E9%83%A8%E6%B5%81%E9%87%8F%E5%BC%95%E5%85%A5%E5%88%B0%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8"><span class="toc-number">0.0.4.</span> <span class="toc-text">ExternalName 类型   [做了一个DNS别名操作，用于把外部流量引入到集群内部]</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8D%E8%B6%B3%E4%B9%8B%E5%A4%84"><span class="toc-number"></span> <span class="toc-text">不足之处</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Userspace"><span class="toc-number">0.0.1.</span> <span class="toc-text">Userspace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iptables"><span class="toc-number">0.0.2.</span> <span class="toc-text">iptables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPVS"><span class="toc-number">0.0.3.</span> <span class="toc-text">IPVS</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        kubernetes_Service
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Sampson.Z</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-11-08T03:24:01.000Z" itemprop="datePublished">2021-11-08</time>
        
        (Updated: <time datetime="2021-11-08T03:24:01.000Z" itemprop="dateModified">2021-11-08</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/K8S/" rel="tag">K8S</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css"><div class=".article-gallery" <h1 id="定义Service"><a href="#定义Service" class="headerlink" title="定义Service"></a>定义Service<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">MyApp</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9376</span><br>      <br></code></pre></td></tr></table></figure>

<h2 id="没有选择符的Service"><a href="#没有选择符的Service" class="headerlink" title="没有选择符的Service"></a>没有选择符的Service</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Endpoints</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br><span class="hljs-attr">subsets:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">addresses:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">192.0</span><span class="hljs-number">.2</span><span class="hljs-number">.42</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9376</span><br><br></code></pre></td></tr></table></figure>
<p>Endpoints 对象的名称是合法的DNS子域名。 my-service  是合法的DNS子域名。</p>
<h1 id="虚拟-IP-和-Service-代理"><a href="#虚拟-IP-和-Service-代理" class="headerlink" title="虚拟 IP 和 Service 代理"></a>虚拟 IP 和 Service 代理</h1><h2 id="userspace-代理模式"><a href="#userspace-代理模式" class="headerlink" title="userspace 代理模式"></a>userspace 代理模式</h2><p>这种模式，kube-proxy 会监视 Kubernetes 控制平面对 Service 对象和 Endpoints 对象的添加和移除操作。 对每个 Service，它会在本地 Node 上打开一个端口（随机选择）。 任何连接到“代理端口”的请求，都会被代理到 Service 的后端 Pods 中的某个上面（如 Endpoints 所报告的一样）。 使用哪个后端 Pod，是 kube-proxy 基于 SessionAffinity 来确定的。</p>
<p>最后，它配置 iptables 规则，捕获到达该 Service 的 clusterIP（是虚拟 IP） 和 Port 的请求，并重定向到代理端口，代理端口再代理请求到后端Pod。<br>默认情况下，用户空间模式下的 kube-proxy 通过轮转算法选择后端。</p>
<p><a href="/service/20211108120823314.png" class="gallery-item"><img src="/2021/11/08/service/20211108120823314.png"></a></p>
<h2 id="iptables-代理模式"><a href="#iptables-代理模式" class="headerlink" title="iptables 代理模式"></a>iptables 代理模式</h2><p>这种模式，kube-proxy 会监视 Kubernetes 控制节点对 Service 对象和 Endpoints 对象的添加和移除。 对每个 Service，它会配置 iptables 规则，从而捕获到达该 Service 的 clusterIP 和端口的请求，进而将请求重定向到 Service 的一组后端中的某个 Pod 上面。 对于每个 Endpoints 对象，它也会配置 iptables 规则，这个规则会选择一个后端组合。</p>
<p>默认的策略是，kube-proxy 在 iptables 模式下随机选择一个后端。</p>
<p>使用 iptables 处理流量具有较低的系统开销，因为流量由 Linux netfilter 处理， 而无需在用户空间和内核空间之间切换。 这种方法也可能更可靠。</p>
<p>如果 kube-proxy 在 iptables 模式下运行，并且所选的第一个 Pod 没有响应， 则连接失败。 这与用户空间模式不同：在这种情况下，kube-proxy 将检测到与第一个 Pod 的连接已失败， 并会自动使用其他后端 Pod 重试。</p>
<p>你可以使用 Pod 就绪探测器 验证后端 Pod 可以正常工作，以便 iptables 模式下的 kube-proxy 仅看到测试正常的后端。 这样做意味着你避免将流量通过 kube-proxy 发送到已知已失败的 Pod。</p>
<p><a href="/service/20211108025250483.png" class="gallery-item"><img src="/2021/11/08/service/20211108025250483.png"></a></p>
<h2 id="IPVS-代理模式"><a href="#IPVS-代理模式" class="headerlink" title="IPVS 代理模式"></a>IPVS 代理模式</h2><p>FEATURE STATE: Kubernetes v1.11 [stable]<br>在 ipvs 模式下，kube-proxy 监视 Kubernetes 服务和端点，调用 netlink 接口相应地创建 IPVS 规则， 并定期将 IPVS 规则与 Kubernetes 服务和端点同步。 该控制循环可确保IPVS 状态与所需状态匹配。访问服务时，IPVS 将流量定向到后端Pod之一。</p>
<p>IPVS代理模式基于类似于 iptables 模式的 netfilter 挂钩函数， 但是使用哈希表作为基础数据结构，并且在内核空间中工作。 这意味着，与 iptables 模式下的 kube-proxy 相比，IPVS 模式下的 kube-proxy 重定向通信的延迟要短，并且在同步代理规则时具有更好的性能。 与其他代理模式相比，IPVS 模式还支持更高的网络流量吞吐量。</p>
<p>IPVS 提供了更多选项来平衡后端 Pod 的流量。 这些是：</p>
<ol>
<li>rr：轮替（Round-Robin）</li>
<li>lc：最少链接（Least Connection），即打开链接数量最少者优先</li>
<li>dh：目标地址哈希（Destination Hashing）</li>
<li>sh：源地址哈希（Source Hashing）</li>
<li>sed：最短预期延迟（Shortest Expected Delay）</li>
<li>nq：从不排队（Never Queue）</li>
</ol>
<p><a href="/service/20211108025354880.png" class="gallery-item"><img src="/2021/11/08/service/20211108025354880.png"></a></p>
<h1 id="多端口Service"><a href="#多端口Service" class="headerlink" title="多端口Service"></a>多端口Service</h1><p>对于某些服务，你需要公开多个端口。 Kubernetes 允许你在 Service 对象上配置多个端口定义。 为服务使用多个端口时，必须提供所有端口名称，以使它们无歧义。 例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">MyApp</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9376</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9377</span><br><br><span class="hljs-comment"># 名字不能包括“_” ，下横杠</span><br></code></pre></td></tr></table></figure>

<h1 id="选择自己的IP地址"><a href="#选择自己的IP地址" class="headerlink" title="选择自己的IP地址"></a>选择自己的IP地址</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">spec.clusterIP</span> <span class="hljs-string">=</span> <span class="hljs-number">10.244</span><span class="hljs-number">.1</span><span class="hljs-number">.240</span><br><br></code></pre></td></tr></table></figure>
<h5 id="需求场景"><a href="#需求场景" class="headerlink" title="需求场景:"></a>需求场景:</h5><p>对于已经存在的DNS解析应用服务，或者遗留系统中已经配置了一个固定的IP地址很难重新配置。 那么可以采用指定clusterIP的方式进行指定。</p>
<h5 id="条件："><a href="#条件：" class="headerlink" title="条件："></a>条件：</h5><ol>
<li> IP 地址必须合法</li>
<li> 个 IP 地址在 service-cluster-ip-range CIDR 范围内</li>
</ol>
<h1 id="流量策略"><a href="#流量策略" class="headerlink" title="流量策略"></a>流量策略</h1><p>你可以通过设置spec.externalTrafficPolicy 字段来控制来自于外部的流量是如何路由的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 字段设为 Cluster 会将外部流量路由到所有就绪的端点</span><br><span class="hljs-string">spec.externalTrafficPolicy</span> <span class="hljs-string">=</span> <span class="hljs-string">Cluser</span><br><span class="hljs-comment"># 设为 Local 会只路由到当前节点上就绪的端点。</span><br><span class="hljs-string">spec.externalTrafficPolicy</span> <span class="hljs-string">=</span> <span class="hljs-string">Local</span><br><span class="hljs-comment"># 如果流量策略设置为 Local，而且当前节点上没有就绪的端点，kube-proxy 不会转发请求相关服务的任何流量。</span><br><br><br></code></pre></td></tr></table></figure>

<h1 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h1><p>Kubernetes 支持两种基本的服务发现模式 —— 环境变量和 DNS。</p>
<h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">REDIS_MASTER_SERVICE_HOST=10.0.0.11</span><br><span class="hljs-string">REDIS_MASTER_SERVICE_PORT=6379</span><br><span class="hljs-string">REDIS_MASTER_PORT=tcp://10.0.0.11:6379</span><br><span class="hljs-string">REDIS_MASTER_PORT_6379_TCP=tcp://10.0.0.11:6379</span><br><span class="hljs-string">REDIS_MASTER_PORT_6379_TCP_PROTO=tcp</span><br><span class="hljs-string">REDIS_MASTER_PORT_6379_TCP_PORT=6379</span><br><span class="hljs-string">REDIS_MASTER_PORT_6379_TCP_ADDR=10.0.0.11</span><br><br><span class="hljs-comment">## 说明：当你具有需要访问服务的 Pod 时，并且你正在使用环境变量方法将端口和集群 IP 发布到客户端 Pod 时，必须在客户端 Pod 出现 之前 创建服务。 否则，这些客户端 Pod 将不会设定其环境变量。如果仅使用 DNS 查找服务的集群 IP，则无需担心此设定问题。</span><br><br></code></pre></td></tr></table></figure>

<h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>例如，如果在命名空间<font color="gray" size="5"> my-ns </font>中有一个名为<font color="gray" size="5"> my-service</font> 的服务， 则控制平面和DNS 服务共同为<font color="gray" size="5"> my-service.my-ns </font> 创建DNS记录。</p>
<p>Kubernetes 还支持命名端口的 DNS SRV（服务）记录。 如果 my-service.my-ns 服务具有名为 http　的端口，且协议设置为 TCP， 则可以对 <font color="gray" size="5">_http._tcp.my-service.my-ns</font> 执行 DNS SRV 查询查询以发现该端口号, “http” 以及 IP 地址。</p>
<p>Kubernetes DNS 服务器是唯一的一种能够访问 ExternalName 类型的 Service 的方式。 更多关于 ExternalName 信息可以查看 DNS Pod</p>
<h1 id="无头服务-【Headless-Services】"><a href="#无头服务-【Headless-Services】" class="headerlink" title="无头服务 【Headless Services】"></a>无头服务 【Headless Services】</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">spec.clusterIP</span> <span class="hljs-string">=</span> <span class="hljs-string">None</span><br></code></pre></td></tr></table></figure>
<h3 id="无头服务测试："><a href="#无头服务测试：" class="headerlink" title="无头服务测试："></a>无头服务测试：</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-headless</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">&quot;None&quot;</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure>
<h3 id="验证dns方式负载的headless-Services"><a href="#验证dns方式负载的headless-Services" class="headerlink" title="验证dns方式负载的headless Services."></a>验证dns方式负载的headless Services.</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"> dig -t A myapp-headless.default.svc.cluster.local. @172.16.166.222<br><span class="hljs-meta">#</span><span class="bash"> 172.16.166.222 是coredns pod 的IP address .</span><br><span class="hljs-meta">#</span><span class="bash"> myapp-headless 是headless app的name</span><br><br></code></pre></td></tr></table></figure>
<p><a href="/service/20211110054907153.png" class="gallery-item"><img src="/2021/11/08/service/20211110054907153.png"></a></p>
<h5 id="带选择算符的服务-【ClusterIP-NodePort-LoadBalancer-ExternalName】"><a href="#带选择算符的服务-【ClusterIP-NodePort-LoadBalancer-ExternalName】" class="headerlink" title="带选择算符的服务 【ClusterIP , NodePort , LoadBalancer, ExternalName】"></a>带选择算符的服务 【ClusterIP , NodePort , LoadBalancer, ExternalName】</h5><p>对定义了选择算符的无头服务，Endpoint 控制器在 API 中创建了 Endpoints 记录， 并且修改 DNS 配置返回 A 记录（IP 地址），通过这个地址直接到达 Service 的后端 Pod 上。</p>
<h5 id="无选择算符的服务"><a href="#无选择算符的服务" class="headerlink" title="无选择算符的服务"></a>无选择算符的服务</h5><p>然而 DNS 系统会查找和配置</p>
<h1 id="发布服务（服务类型"><a href="#发布服务（服务类型" class="headerlink" title="发布服务（服务类型)"></a>发布服务（服务类型)</h1><p>对一些应用的某些部分（如前端），可能希望将其暴露给 Kubernetes 集群外部 的 IP 地址。</p>
<h4 id="Kubernetes-ServiceTypes-允许指定你所需要的-Service-类型，默认是-ClusterIP。"><a href="#Kubernetes-ServiceTypes-允许指定你所需要的-Service-类型，默认是-ClusterIP。" class="headerlink" title="Kubernetes ServiceTypes 允许指定你所需要的 Service 类型，默认是 ClusterIP。"></a>Kubernetes ServiceTypes 允许指定你所需要的 Service 类型，默认是 ClusterIP。</h4><p>Type 的取值以及行为如下：</p>
<ol>
<li><p>ClusterIP：通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是默认的 ServiceType。</p>
</li>
<li><p>NodePort：通过每个节点上的 IP 和静态端口（NodePort）暴露服务。 NodePort 服务会路由到自动创建的 ClusterIP 服务。 通过请求 &lt;节点 IP&gt;:&lt;节点端口&gt;，你可以从集群的外部访问一个 NodePort 服务。</p>
</li>
<li><p>LoadBalancer：使用云提供商的负载均衡器向外部暴露服务。 外部负载均衡器可以将流量路由到自动创建的 NodePort 服务和 ClusterIP 服务上。</p>
</li>
<li><p>ExternalName：通过返回 CNAME 和对应值，可以将服务映射到 externalName 字段的内容（例如，foo.bar.example.com）。 无需创建任何类型代理。</p>
</li>
</ol>
<p>说明： 你需要使用 kube-dns 1.7 及以上版本或者 CoreDNS 0.0.8 及以上版本才能使用 ExternalName 类型。<br>你也可以使用 Ingress 来暴露自己的服务。 Ingress 不是一种服务类型，但它充当集群的入口点。 它可以将路由规则整合到一个资源中，因为它可以在同一IP地址下公开多个服务。</p>
<h4 id="NodePort-类型"><a href="#NodePort-类型" class="headerlink" title="NodePort 类型"></a>NodePort 类型</h4><p>如果你将 type 字段设置为 NodePort，则 Kubernetes 控制平面将在 –service-node-port-range 标志指定的范围内分配端口（默认值：<font color="red" size="4">30000-32767</font>）。 每个节点将那个端口（每个节点上的相同端口号）代理到你的服务中。 你的服务在其</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">.spec.ports[*].nodePort</span> <span class="hljs-comment"># 字段中要求分配的端口。</span><br></code></pre></td></tr></table></figure>
<p>如果你想指定特定的 IP 代理端口，则可以设置 kube-proxy 中的 –nodeport-addresses 参数 或者将kube-proxy 配置文件 中的等效 nodePortAddresses 字段设置为特定的 IP 块。 该标志采用逗号分隔的 IP 块列表（例如，10.0.0.0/8、192.0.2.0/25）来指定 kube-proxy 应该认为是此节点本地的 IP 地址范围。</p>
<p>例如，如果你使用 –nodeport-addresses=127.0.0.0/8 标志启动 kube-proxy， 则 kube-proxy 仅选择 NodePort Services 的本地回路接口。 –nodeport-addresses 的默认值是一个空列表。 这意味着 kube-proxy 应该考虑 NodePort 的所有可用网络接口。 （这也与早期的 Kubernetes 版本兼容）。</p>
<p>如果需要特定的端口号，你可以在 nodePort 字段中指定一个值。 控制平面将为你分配该端口或报告 API 事务失败。 这意味着你需要自己注意可能发生的端口冲突。 你还必须使用有效的端口号，该端口号在配置用于 NodePort 的范围内。</p>
<p>使用 NodePort 可以让你自由设置自己的负载均衡解决方案， 配置 Kubernetes 不完全支持的环境， 甚至直接暴露一个或多个节点的 IP。</p>
<p>需要注意的是，Service 能够通过 <NodeIP>:spec.ports[<em>].nodePort 和 spec.clusterIp:spec.ports[</em>].port 而对外可见。 如果设置了 kube-proxy 的 –nodeport-addresses 参数或 kube-proxy 配置文件中的等效字段， <NodeIP> 将被过滤 NodeIP。</NodeIP></NodeIP></p>
<p>例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">MyApp</span><br>  <span class="hljs-attr">ports:</span><br>      <span class="hljs-comment"># 默认情况下，为了方便起见，`targetPort` 被设置为与 `port` 字段相同的值。</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>      <span class="hljs-comment"># 可选字段</span><br>      <span class="hljs-comment"># 默认情况下，为了方便起见，Kubernetes 控制平面会从某个范围内分配一个端口号（默认：30000-32767）</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30007</span><br>      <br></code></pre></td></tr></table></figure>
<p><a href="/service/20211110055857455.png" class="gallery-item"><img src="/2021/11/08/service/20211110055857455.png"></a></p>
<p><a href="/service/20211110055935543.png" class="gallery-item"><img src="/2021/11/08/service/20211110055935543.png"></a></p>
<h4 id="LoadBalancer-类型"><a href="#LoadBalancer-类型" class="headerlink" title="LoadBalancer 类型"></a>LoadBalancer 类型</h4><p>在使用支持外部负载均衡器的云提供商的服务时，设置 type 的值为 “LoadBalancer”， 将为 Service 提供负载均衡器。 负载均衡器是异步创建的，关于被提供的负载均衡器的信息将会通过 Service 的 status.loadBalancer 字段发布出去。</p>
<p>实例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">MyApp</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9376</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.171</span><span class="hljs-number">.239</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br><span class="hljs-attr">status:</span><br>  <span class="hljs-attr">loadBalancer:</span><br>    <span class="hljs-attr">ingress:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">192.0</span><span class="hljs-number">.2</span><span class="hljs-number">.127</span><br></code></pre></td></tr></table></figure>

<p>来自外部负载均衡器的流量将直接重定向到后端 Pod 上，不过实际它们是如何工作的，这要依赖于云提供商。</p>
<p>某些云提供商允许设置 loadBalancerIP。 在这些情况下，将根据用户设置的 loadBalancerIP 来创建负载均衡器。 如果没有设置 loadBalancerIP 字段，将会给负载均衡器指派一个临时 IP。 如果设置了 loadBalancerIP，但云提供商并不支持这种特性，那么设置的 loadBalancerIP 值将会被忽略掉。</p>
<p>说明：<br>在 Azure 上，如果要使用用户指定的公共类型 loadBalancerIP，则 首先需要创建静态类型的公共 IP 地址资源。 此公共 IP 地址资源应与集群中其他自动创建的资源位于同一资源组中。 例如，MC_myResourceGroup_myAKSCluster_eastus。</p>
<p>将分配的 IP 地址设置为 loadBalancerIP。确保你已更新云提供程序配置文件中的 securityGroupName。 有关对 CreatingLoadBalancerFailed 权限问题进行故障排除的信息， 请参阅 与 Azure Kubernetes 服务（AKS）负载平衡器一起使用静态 IP 地址 或在 AKS 集群上使用高级联网时出现 CreatingLoadBalancerFailed。</p>
<p>混合协议类型的负载均衡器<br>FEATURE STATE: Kubernetes v1.20 [alpha]<br>默认情况下，对于 LoadBalancer 类型的服务，当定义了多个端口时，所有 端口必须具有相同的协议，并且该协议必须是受云提供商支持的协议。</p>
<p>如果为 kube-apiserver 启用了 MixedProtocolLBService 特性门控， 则当定义了多个端口时，允许使用不同的协议。</p>
<p>说明： 可用于 LoadBalancer 类型服务的协议集仍然由云提供商决定。<br>禁用负载均衡器节点端口分配<br>FEATURE STATE: Kubernetes v1.20 [alpha]<br>从 v1.20 版本开始， 你可以通过设置 spec.allocateLoadBalancerNodePorts 为 false 对类型为 LoadBalancer 的服务禁用节点端口分配。 这仅适用于直接将流量路由到 Pod 而不是使用节点端口的负载均衡器实现。 默认情况下，spec.allocateLoadBalancerNodePorts 为 true， LoadBalancer 类型的服务继续分配节点端口。 如果现有服务已被分配节点端口，将参数 spec.allocateLoadBalancerNodePorts 设置为 false 时，这些服务上已分配置的节点端口不会被自动释放。 你必须显式地在每个服务端口中删除 nodePorts 项以释放对应端口。 你必须启用 ServiceLBNodePortControl 特性门控才能使用该字段。</p>
<p>设置负载均衡器实现的类别<br>FEATURE STATE: Kubernetes v1.22 [beta]<br>spec.loadBalancerClass 允许你不使用云提供商的默认负载均衡器实现，转而使用指定的负载均衡器实现。 这个特性从 v1.21 版本开始可以使用，你在 v1.21 版本中使用这个字段必须启用 ServiceLoadBalancerClass 特性门控，这个特性门控从 v1.22 版本及以后默认打开。 默认情况下，.spec.loadBalancerClass 的取值是 nil，如果集群使用 –cloud-provider 配置了云提供商， LoadBalancer 类型服务会使用云提供商的默认负载均衡器实现。 如果设置了 .spec.loadBalancerClass，则假定存在某个与所指定的类相匹配的 负载均衡器实现在监视服务变化。 所有默认的负载均衡器实现（例如，由云提供商所提供的）都会忽略设置了此字段 的服务。.spec.loadBalancerClass 只能设置到类型为 LoadBalancer 的 Service 之上，而且一旦设置之后不可变更。</p>
<p>.spec.loadBalancerClass 的值必须是一个标签风格的标识符， 可以有选择地带有类似 “internal-vip” 或 “example.com/internal-vip” 这类 前缀。没有前缀的名字是保留给最终用户的。</p>
<p>内部负载均衡器<br>在混合环境中，有时有必要在同一(虚拟)网络地址块内路由来自服务的流量。</p>
<p>在水平分割 DNS 环境中，你需要两个服务才能将内部和外部流量都路由到你的端点（Endpoints）。</p>
<p>如要设置内部负载均衡器，请根据你所使用的云运营商，为服务添加以下注解之一。</p>
<p>Default<br>GCP<br>AWS<br>Azure<br>IBM Cloud<br>OpenStack<br>Baidu Cloud<br>Tencent Cloud<br>Alibaba Cloud<br>选择一个标签</p>
<p>AWS TLS 支持<br>为了对在 AWS 上运行的集群提供 TLS/SSL 部分支持，你可以向 LoadBalancer 服务添加三个注解：</p>
<p>metadata:<br>  name: my-service<br>  annotations:<br>    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: arn:aws:acm:us-east-1:123456789012:certificate/12345678-1234-1234-1234-123456789012<br>第一个指定要使用的证书的 ARN。 它可以是已上载到 IAM 的第三方颁发者的证书， 也可以是在 AWS Certificate Manager 中创建的证书。</p>
<p>metadata:<br>  name: my-service<br>  annotations:<br>    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: (https|http|ssl|tcp)<br>第二个注解指定 Pod 使用哪种协议。 对于 HTTPS 和 SSL，ELB 希望 Pod 使用证书 通过加密连接对自己进行身份验证。</p>
<p>HTTP 和 HTTPS 选择第7层代理：ELB 终止与用户的连接，解析标头，并在转发请求时向 X-Forwarded-For 标头注入用户的 IP 地址（Pod 仅在连接的另一端看到 ELB 的 IP 地址）。</p>
<p>TCP 和 SSL 选择第4层代理：ELB 转发流量而不修改报头。</p>
<p>在某些端口处于安全状态而其他端口未加密的混合使用环境中，可以使用以下注解：</p>
<pre><code>metadata:
  name: my-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: http
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: &quot;443,8443&quot;
</code></pre>
<p>在上例中，如果服务包含 80、443 和 8443 三个端口， 那么 443 和 8443 将使用 SSL 证书， 而 80 端口将转发 HTTP 数据包。</p>
<p>从 Kubernetes v1.9 起可以使用 预定义的 AWS SSL 策略 为你的服务使用 HTTPS 或 SSL 侦听器。 要查看可以使用哪些策略，可以使用 aws 命令行工具：</p>
<p>aws elb describe-load-balancer-policies –query ‘PolicyDescriptions[].PolicyName’<br>然后，你可以使用 “service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy” 注解; 例如：</p>
<pre><code>metadata:
  name: my-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy: &quot;ELBSecurityPolicy-TLS-1-2-2017-01&quot;
</code></pre>
<p>AWS 上的 PROXY 协议支持<br>为了支持在 AWS 上运行的集群，启用 PROXY 协议。 你可以使用以下服务注解：</p>
<pre><code>metadata:
  name: my-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: &quot;*&quot;
</code></pre>
<p>从 1.3.0 版开始，此注解的使用适用于 ELB 代理的所有端口，并且不能进行其他配置。</p>
<p>AWS 上的 ELB 访问日志<br>有几个注解可用于管理 AWS 上 ELB 服务的访问日志。</p>
<p>注解 service.beta.kubernetes.io/aws-load-balancer-access-log-enabled 控制是否启用访问日志。</p>
<p>注解 service.beta.kubernetes.io/aws-load-balancer-access-log-emit-interval 控制发布访问日志的时间间隔（以分钟为单位）。你可以指定 5 分钟或 60 分钟的间隔。</p>
<p>注解 service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-name 控制存储负载均衡器访问日志的 Amazon S3 存储桶的名称。</p>
<p>注解 service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-prefix 指定为 Amazon S3 存储桶创建的逻辑层次结构。</p>
<pre><code>metadata:
  name: my-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-access-log-enabled: &quot;true&quot;
    # 指定是否为负载均衡器启用访问日志
    service.beta.kubernetes.io/aws-load-balancer-access-log-emit-interval: &quot;60&quot;
    # 发布访问日志的时间间隔。你可以将其设置为 5 分钟或 60 分钟。
    service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-name: &quot;my-bucket&quot;
    # 用来存放访问日志的 Amazon S3 Bucket 名称
    service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-prefix: &quot;my-bucket-prefix/prod&quot;
    # 你为 Amazon S3 Bucket 所创建的逻辑层次结构，例如 `my-bucket-prefix/prod`
</code></pre>
<p>AWS 上的连接排空<br>可以将注解 service.beta.kubernetes.io/aws-load-balancer-connection-draining-enabled 设置为 “true” 来管理 ELB 的连接排空。 注解 service.beta.kubernetes.io/aws-load-balancer-connection-draining-timeout 也可以用于设置最大时间（以秒为单位），以保持现有连接在注销实例之前保持打开状态。</p>
<pre><code>metadata:
  name: my-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-connection-draining-enabled: &quot;true&quot;
    service.beta.kubernetes.io/aws-load-balancer-connection-draining-timeout: &quot;60&quot;
</code></pre>
<p>其他 ELB 注解<br>还有其他一些注解，用于管理经典弹性负载均衡器，如下所述。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-comment"># 按秒计的时间，表示负载均衡器关闭连接之前连接可以保持空闲</span><br>    <span class="hljs-comment"># （连接上无数据传输）的时间长度</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout:</span> <span class="hljs-string">&quot;60&quot;</span><br><br>    <span class="hljs-comment"># 指定该负载均衡器上是否启用跨区的负载均衡能力</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled:</span> <span class="hljs-string">&quot;true&quot;</span><br><br>    <span class="hljs-comment"># 逗号分隔列表值，每一项都是一个键-值耦对，会作为额外的标签记录于 ELB 中</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags:</span> <span class="hljs-string">&quot;environment=prod,owner=devops&quot;</span><br><br>    <span class="hljs-comment"># 将某后端视为健康、可接收请求之前需要达到的连续成功健康检查次数。</span><br>    <span class="hljs-comment"># 默认为 2，必须介于 2 和 10 之间</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold:</span> <span class="hljs-string">&quot;&quot;</span><br><br>    <span class="hljs-comment"># 将某后端视为不健康、不可接收请求之前需要达到的连续不成功健康检查次数。</span><br>    <span class="hljs-comment"># 默认为 6，必须介于 2 和 10 之间</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold:</span> <span class="hljs-string">&quot;3&quot;</span><br><br>    <span class="hljs-comment"># 对每个实例进行健康检查时，连续两次检查之间的大致间隔秒数</span><br>    <span class="hljs-comment"># 默认为 10，必须介于 5 和 300 之间</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval:</span> <span class="hljs-string">&quot;20&quot;</span><br><br>    <span class="hljs-comment"># 时长秒数，在此期间没有响应意味着健康检查失败</span><br>    <span class="hljs-comment"># 此值必须小于 service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval</span><br>    <span class="hljs-comment"># 默认值为 5，必须介于 2 和 60 之间</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout:</span> <span class="hljs-string">&quot;5&quot;</span><br><br>    <span class="hljs-comment"># 由已有的安全组所构成的列表，可以配置到所创建的 ELB 之上。</span><br>    <span class="hljs-comment"># 与注解 service.beta.kubernetes.io/aws-load-balancer-extra-security-groups 不同，</span><br>    <span class="hljs-comment"># 这一设置会替代掉之前指定给该 ELB 的所有其他安全组，也会覆盖掉为此</span><br>    <span class="hljs-comment"># ELB 所唯一创建的安全组。 </span><br>    <span class="hljs-comment"># 此列表中的第一个安全组 ID 被用来作为决策源，以允许入站流量流入目标工作节点</span><br>    <span class="hljs-comment"># (包括服务流量和健康检查）。</span><br>    <span class="hljs-comment"># 如果多个 ELB 配置了相同的安全组 ID，为工作节点安全组添加的允许规则行只有一个，</span><br>    <span class="hljs-comment"># 这意味着如果你删除了这些 ELB 中的任何一个，都会导致该规则记录被删除，</span><br>    <span class="hljs-comment"># 以至于所有共享该安全组 ID 的其他 ELB 都无法访问该节点。</span><br>    <span class="hljs-comment"># 此注解如果使用不当，会导致跨服务的不可用状况。</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-security-groups:</span> <span class="hljs-string">&quot;sg-53fae93f&quot;</span><br><br>    <span class="hljs-comment"># 额外的安全组列表，将被添加到所创建的 ELB 之上。</span><br>    <span class="hljs-comment"># 添加时，会保留为 ELB 所专门创建的安全组。</span><br>    <span class="hljs-comment"># 这样会确保每个 ELB 都有一个唯一的安全组 ID 和与之对应的允许规则记录，</span><br>    <span class="hljs-comment"># 允许请求（服务流量和健康检查）发送到目标工作节点。</span><br>    <span class="hljs-comment"># 这里顶一个安全组可以被多个服务共享。</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-extra-security-groups:</span> <span class="hljs-string">&quot;sg-53fae93f,sg-42efd82e&quot;</span><br><br>    <span class="hljs-comment"># 用逗号分隔的一个键-值偶对列表，用来为负载均衡器选择目标节点</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-target-node-labels:</span> <span class="hljs-string">&quot;ingress-gw,gw-name=public-api&quot;</span><br></code></pre></td></tr></table></figure>

<p>AWS 上网络负载均衡器支持<br>FEATURE STATE: Kubernetes v1.15 [beta]<br>要在 AWS 上使用网络负载均衡器，可以使用注解 service.beta.kubernetes.io/aws-load-balancer-type，将其取值设为 nlb。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-type:</span> <span class="hljs-string">&quot;nlb&quot;</span><br></code></pre></td></tr></table></figure>

<p>说明： NLB 仅适用于某些实例类。有关受支持的实例类型的列表， 请参见 AWS文档 中关于所支持的实例类型的 Elastic Load Balancing 说明。<br>与经典弹性负载平衡器不同，网络负载平衡器（NLB）将客户端的 IP 地址转发到该节点。 如果服务的 .spec.externalTrafficPolicy 设置为 Cluster ，则客户端的IP地址不会传达到最终的 Pod。</p>
<p>通过将 .spec.externalTrafficPolicy 设置为 Local，客户端IP地址将传播到最终的 Pod， 但这可能导致流量分配不均。 没有针对特定 LoadBalancer 服务的任何 Pod 的节点将无法通过自动分配的 .spec.healthCheckNodePort 进行 NLB 目标组的运行状况检查，并且不会收到任何流量。</p>
<p>为了获得均衡流量，请使用 DaemonSet 或指定 Pod 反亲和性 使其不在同一节点上。</p>
<p>你还可以将 NLB 服务与内部负载平衡器 注解一起使用。</p>
<p>为了使客户端流量能够到达 NLB 后面的实例，使用以下 IP 规则修改了节点安全组：</p>
<p>Rule    Protocol    Port(s)    IpRange(s)    IpRange Description<br>Health Check    TCP    NodePort(s) (.spec.healthCheckNodePort for .spec.externalTrafficPolicy = Local)    Subnet CIDR    kubernetes.io/rule/nlb/health=<loadBalancerName><br>Client Traffic    TCP    NodePort(s)    .spec.loadBalancerSourceRanges (defaults to 0.0.0.0/0)    kubernetes.io/rule/nlb/client=<loadBalancerName><br>MTU Discovery    ICMP    3,4    .spec.loadBalancerSourceRanges (defaults to 0.0.0.0/0)    kubernetes.io/rule/nlb/mtu=<loadBalancerName><br>为了限制哪些客户端IP可以访问网络负载平衡器，请指定 loadBalancerSourceRanges。</loadBalancerName></loadBalancerName></loadBalancerName></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">loadBalancerSourceRanges:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;143.231.0.0/16&quot;</span><br></code></pre></td></tr></table></figure>
<p>说明： 如果未设置 .spec.loadBalancerSourceRanges ，则 Kubernetes 允许从 0.0.0.0/0 到节点安全组的流量。 如果节点具有公共 IP 地址，请注意，非 NLB 流量也可以到达那些修改后的安全组中的所有实例。<br>腾讯 Kubernetes 引擎（TKE）上的 CLB 注解<br>以下是在 TKE 上管理云负载均衡器的注解。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-comment"># 绑定负载均衡器到指定的节点。</span><br>    <span class="hljs-attr">service.kubernetes.io/qcloud-loadbalancer-backends-label:</span> <span class="hljs-string">key</span> <span class="hljs-string">in</span> <span class="hljs-string">(value1,</span> <span class="hljs-string">value2)</span><br><br>    <span class="hljs-comment"># 为已有负载均衡器添加 ID。</span><br>    <span class="hljs-string">service.kubernetes.io/tke-existed-lbid：lb-6swtxxxx</span><br><br>    <span class="hljs-comment"># 负载均衡器（LB）的自定义参数尚不支持修改 LB 类型。</span><br>    <span class="hljs-attr">service.kubernetes.io/service.extensiveParameters:</span> <span class="hljs-string">&quot;&quot;</span><br><br>    <span class="hljs-comment"># 自定义负载均衡监听器。</span><br>    <span class="hljs-attr">service.kubernetes.io/service.listenerParameters:</span> <span class="hljs-string">&quot;&quot;</span><br><br>    <span class="hljs-comment"># 指定负载均衡类型。</span><br>    <span class="hljs-comment"># 可用参数: classic (Classic Cloud Load Balancer) 或 application (Application Cloud Load Balancer)</span><br>    <span class="hljs-attr">service.kubernetes.io/loadbalance-type:</span> <span class="hljs-string">xxxxx</span><br><br>    <span class="hljs-comment"># 指定公用网络带宽计费方法。</span><br>    <span class="hljs-comment"># 可用参数: TRAFFIC_POSTPAID_BY_HOUR(bill-by-traffic) 和 BANDWIDTH_POSTPAID_BY_HOUR (bill-by-bandwidth).</span><br>    <span class="hljs-attr">service.kubernetes.io/qcloud-loadbalancer-internet-charge-type:</span> <span class="hljs-string">xxxxxx</span><br><br>    <span class="hljs-comment"># 指定带宽参数 (取值范围： [1,2000] Mbps).</span><br>    <span class="hljs-attr">service.kubernetes.io/qcloud-loadbalancer-internet-max-bandwidth-out:</span> <span class="hljs-string">&quot;10&quot;</span><br><br>    <span class="hljs-comment"># 当设置该注解时，负载平衡器将只注册正在运行 Pod 的节点，</span><br>    <span class="hljs-comment"># 否则所有节点将会被注册。</span><br>    <span class="hljs-attr">service.kubernetes.io/local-svc-only-bind-node-with-pod:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<h4 id="ExternalName-类型-做了一个DNS别名操作，用于把外部流量引入到集群内部"><a href="#ExternalName-类型-做了一个DNS别名操作，用于把外部流量引入到集群内部" class="headerlink" title="ExternalName 类型   [做了一个DNS别名操作，用于把外部流量引入到集群内部]"></a>ExternalName 类型   [做了一个DNS别名操作，用于把外部流量引入到集群内部]</h4><p>类型为 ExternalName 的服务将服务映射到 DNS 名称，而不是典型的选择器，例如 my-service 或者 cassandra。 你可以使用 spec.externalName 参数指定这些服务。</p>
<p>例如，以下 Service 定义将 prod 名称空间中的 my-service 服务映射到 my.database.example.com：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">prod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ExternalName</span><br>  <span class="hljs-attr">externalName:</span> <span class="hljs-string">my.database.example.com</span><br></code></pre></td></tr></table></figure>

<p><a href="/service/20211110060503808.png" class="gallery-item"><img src="/2021/11/08/service/20211110060503808.png"></a></p>
<p><a href="/service/20211110060632133.png" class="gallery-item"><img src="/2021/11/08/service/20211110060632133.png"></a></p>
<p>说明： ExternalName 服务接受 IPv4 地址字符串，但作为包含数字的 DNS 名称，而不是 IP 地址。 类似于 IPv4 地址的外部名称不能由 CoreDNS 或 ingress-nginx 解析，因为外部名称旨在指定规范的 DNS 名称。 要对 IP 地址进行硬编码，请考虑使用 headless Services。<br>当查找主机 my-service.prod.svc.cluster.local 时，集群 DNS 服务返回 CNAME 记录， 其值为 my.database.example.com。 访问 my-service 的方式与其他服务的方式相同，但主要区别在于重定向发生在 DNS 级别，而不是通过代理或转发。 如果以后你决定将数据库移到集群中，则可以启动其 Pod，添加适当的选择器或端点以及更改服务的 type。</p>
<p><font color="red" size="2">警告：<br>对于一些常见的协议，包括 HTTP 和 HTTPS， 你使用 ExternalName 可能会遇到问题。 如果你使用 ExternalName，那么集群内客户端使用的主机名 与 ExternalName 引用的名称不同。</font></p>
<p>对于使用主机名的协议，此差异可能会导致错误或意外响应。 HTTP 请求将具有源服务器无法识别的 Host: 标头；TLS 服 务器将无法提供与客户端连接的主机名匹配的证书。</p>
<p>说明： 本部分感谢 Alen Komljen的 Kubernetes Tips - Part1 博客文章。<br>外部 IP<br>如果外部的 IP 路由到集群中一个或多个 Node 上，Kubernetes Service 会被暴露给这些 externalIPs。 通过外部 IP（作为目的 IP 地址）进入到集群，打到 Service 的端口上的流量， 将会被路由到 Service 的 Endpoint 上。 externalIPs 不会被 Kubernetes 管理，它属于集群管理员的职责范畴。</p>
<p>根据 Service 的规定，externalIPs 可以同任意的 ServiceType 来一起指定。 在上面的例子中，my-service 可以在 “80.11.12.10:80”(externalIP:port) 上被客户端访问。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">MyApp</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9376</span><br>  <span class="hljs-attr">externalIPs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-number">80.11</span><span class="hljs-number">.12</span><span class="hljs-number">.10</span><br></code></pre></td></tr></table></figure>

<h1 id="不足之处"><a href="#不足之处" class="headerlink" title="不足之处"></a>不足之处</h1><p>为 VIP 使用用户空间代理，将只适合小型到中型规模的集群，不能够扩展到上千 Service 的大型集群。 查看最初设计方案 获取更多细节。</p>
<p>使用用户空间代理，隐藏了访问 Service 的数据包的源 IP 地址。 这使得一些类型的防火墙无法起作用。 iptables 代理不会隐藏 Kubernetes 集群内部的 IP 地址，但却要求客户端请求 必须通过一个负载均衡器或 Node 端口。</p>
<p>Type 字段支持嵌套功能 —— 每一层需要添加到上一层里面。 不会严格要求所有云提供商（例如，GCE 就没必要为了使一个 LoadBalancer 能工作而分配一个 NodePort，但是 AWS 需要 ），但当前 API 是强制要求的。</p>
<p>虚拟IP实施<br>对很多想使用 Service 的人来说，前面的信息应该足够了。 然而，有很多内部原理性的内容，还是值去理解的。</p>
<p>避免冲突<br>Kubernetes 最主要的哲学之一，是用户不应该暴露那些能够导致他们操作失败、但又不是他们的过错的场景。 对于 Service 资源的设计，这意味着如果用户的选择有可能与他人冲突，那就不要让用户自行选择端口号。 这是一个隔离性的失败。</p>
<p>为了使用户能够为他们的 Service 选择一个端口号，我们必须确保不能有2个 Service 发生冲突。 Kubernetes 通过为每个 Service 分配它们自己的 IP 地址来实现。</p>
<p>为了保证每个 Service 被分配到一个唯一的 IP，需要一个内部的分配器能够原子地更新 etcd 中的一个全局分配映射表， 这个更新操作要先于创建每一个 Service。 为了使 Service 能够获取到 IP，这个映射表对象必须在注册中心存在， 否则创建 Service 将会失败，指示一个 IP 不能被分配。</p>
<p>在控制平面中，一个后台 Controller 的职责是创建映射表 （需要支持从使用了内存锁的 Kubernetes 的旧版本迁移过来）。 同时 Kubernetes 会通过控制器检查不合理的分配（如管理员干预导致的） 以及清理已被分配但不再被任何 Service 使用的 IP 地址。</p>
<p>Service IP 地址<br>不像 Pod 的 IP 地址，它实际路由到一个固定的目的地，Service 的 IP 实际上 不能通过单个主机来进行应答。 相反，我们使用 iptables（Linux 中的数据包处理逻辑）来定义一个 虚拟 IP 地址（VIP），它可以根据需要透明地进行重定向。 当客户端连接到 VIP 时，它们的流量会自动地传输到一个合适的 Endpoint。 环境变量和 DNS，实际上会根据 Service 的 VIP 和端口来进行填充。</p>
<p>kube-proxy支持三种代理模式: 用户空间，iptables和IPVS；它们各自的操作略有不同。</p>
<h4 id="Userspace"><a href="#Userspace" class="headerlink" title="Userspace"></a>Userspace</h4><p>作为一个例子，考虑前面提到的图片处理应用程序。 当创建后端 Service 时，Kubernetes master 会给它指派一个虚拟 IP 地址，比如 10.0.0.1。 假设 Service 的端口是 1234，该 Service 会被集群中所有的 kube-proxy 实例观察到。 当代理看到一个新的 Service， 它会打开一个新的端口，建立一个从该 VIP 重定向到 新端口的 iptables，并开始接收请求连接。</p>
<p>当一个客户端连接到一个 VIP，iptables 规则开始起作用，它会重定向该数据包到 “服务代理” 的端口。 “服务代理” 选择一个后端，并将客户端的流量代理到后端上。</p>
<p>这意味着 Service 的所有者能够选择任何他们想使用的端口，而不存在冲突的风险。 客户端可以连接到一个 IP 和端口，而不需要知道实际访问了哪些 Pod。</p>
<h4 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h4><p>再次考虑前面提到的图片处理应用程序。 当创建后端 Service 时，Kubernetes 控制面板会给它指派一个虚拟 IP 地址，比如 10.0.0.1。 假设 Service 的端口是 1234，该 Service 会被集群中所有的 kube-proxy 实例观察到。 当代理看到一个新的 Service， 它会配置一系列的 iptables 规则，从 VIP 重定向到每个 Service 规则。 该特定于服务的规则连接到特定于 Endpoint 的规则，而后者会重定向（目标地址转译）到后端。</p>
<p>当客户端连接到一个 VIP，iptables 规则开始起作用。一个后端会被选择（或者根据会话亲和性，或者随机）， 数据包被重定向到这个后端。 不像用户空间代理，数据包从来不拷贝到用户空间，kube-proxy 不是必须为该 VIP 工作而运行， 并且客户端 IP 是不可更改的。</p>
<p>当流量打到 Node 的端口上，或通过负载均衡器，会执行相同的基本流程， 但是在那些案例中客户端 IP 是可以更改的。</p>
<h4 id="IPVS"><a href="#IPVS" class="headerlink" title="IPVS"></a>IPVS</h4><p>在大规模集群（例如 10000 个服务）中，iptables 操作会显着降低速度。 IPVS 专为负载平衡而设计，并基于内核内哈希表。 因此，你可以通过基于 IPVS 的 kube-proxy 在大量服务中实现性能一致性。 同时，基于 IPVS 的 kube-proxy 具有更复杂的负载均衡算法（最小连接、局部性、 加权、持久性）。</p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>












		<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
		<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
		<!--<script src="//cdn.jsdelivr.net/npm/leancloud-storage@latest/dist/av-min.js"></script>
    <script src='//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js'></script>-->
	<div id="vcomments"></div>
	<script>
		var notify = false == true ? true : false;
		var verify = false == true ? true : false;
		var visitor = true == true ? true : false;
  new Valine({
      el: '#vcomments',
				notify: notify,
				verify: verify,
    	app_id: 'blb6PJsThCi2aLC84uljjQzT-gzGzoHsz',
      app_key: '1PBJebm7VF0AiFpsf6Hhapdv',
			lang: 'en',
			placeholder: 'ヾﾉ≧∀≦)o快来评论一下吧!',
			avatar: 'monsterid',
			pageSize: 10,
			visitor: visitor
        });
    </script>






        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/zhuxinkai.site/">zhuxinkai.site</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89%E9%80%89%E6%8B%A9%E7%AC%A6%E7%9A%84Service"><span class="toc-number">1.</span> <span class="toc-text">没有选择符的Service</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F-IP-%E5%92%8C-Service-%E4%BB%A3%E7%90%86"><span class="toc-number"></span> <span class="toc-text">虚拟 IP 和 Service 代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#userspace-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">userspace 代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">iptables 代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPVS-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">IPVS 代理模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E7%AB%AF%E5%8F%A3Service"><span class="toc-number"></span> <span class="toc-text">多端口Service</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E8%87%AA%E5%B7%B1%E7%9A%84IP%E5%9C%B0%E5%9D%80"><span class="toc-number"></span> <span class="toc-text">选择自己的IP地址</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%9C%BA%E6%99%AF"><span class="toc-number">0.0.0.1.</span> <span class="toc-text">需求场景:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%EF%BC%9A"><span class="toc-number">0.0.0.2.</span> <span class="toc-text">条件：</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E7%AD%96%E7%95%A5"><span class="toc-number"></span> <span class="toc-text">流量策略</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number"></span> <span class="toc-text">服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.</span> <span class="toc-text">环境变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS"><span class="toc-number">1.1.</span> <span class="toc-text">DNS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1-%E3%80%90Headless-Services%E3%80%91"><span class="toc-number"></span> <span class="toc-text">无头服务 【Headless Services】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%A4%B4%E6%9C%8D%E5%8A%A1%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="toc-number">0.1.</span> <span class="toc-text">无头服务测试：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81dns%E6%96%B9%E5%BC%8F%E8%B4%9F%E8%BD%BD%E7%9A%84headless-Services"><span class="toc-number">0.2.</span> <span class="toc-text">验证dns方式负载的headless Services.</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%A6%E9%80%89%E6%8B%A9%E7%AE%97%E7%AC%A6%E7%9A%84%E6%9C%8D%E5%8A%A1-%E3%80%90ClusterIP-NodePort-LoadBalancer-ExternalName%E3%80%91"><span class="toc-number">0.2.0.1.</span> <span class="toc-text">带选择算符的服务 【ClusterIP , NodePort , LoadBalancer, ExternalName】</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E9%80%89%E6%8B%A9%E7%AE%97%E7%AC%A6%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">0.2.0.2.</span> <span class="toc-text">无选择算符的服务</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E6%9C%8D%E5%8A%A1%EF%BC%88%E6%9C%8D%E5%8A%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number"></span> <span class="toc-text">发布服务（服务类型)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes-ServiceTypes-%E5%85%81%E8%AE%B8%E6%8C%87%E5%AE%9A%E4%BD%A0%E6%89%80%E9%9C%80%E8%A6%81%E7%9A%84-Service-%E7%B1%BB%E5%9E%8B%EF%BC%8C%E9%BB%98%E8%AE%A4%E6%98%AF-ClusterIP%E3%80%82"><span class="toc-number">0.0.1.</span> <span class="toc-text">Kubernetes ServiceTypes 允许指定你所需要的 Service 类型，默认是 ClusterIP。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NodePort-%E7%B1%BB%E5%9E%8B"><span class="toc-number">0.0.2.</span> <span class="toc-text">NodePort 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LoadBalancer-%E7%B1%BB%E5%9E%8B"><span class="toc-number">0.0.3.</span> <span class="toc-text">LoadBalancer 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ExternalName-%E7%B1%BB%E5%9E%8B-%E5%81%9A%E4%BA%86%E4%B8%80%E4%B8%AADNS%E5%88%AB%E5%90%8D%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%94%A8%E4%BA%8E%E6%8A%8A%E5%A4%96%E9%83%A8%E6%B5%81%E9%87%8F%E5%BC%95%E5%85%A5%E5%88%B0%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8"><span class="toc-number">0.0.4.</span> <span class="toc-text">ExternalName 类型   [做了一个DNS别名操作，用于把外部流量引入到集群内部]</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8D%E8%B6%B3%E4%B9%8B%E5%A4%84"><span class="toc-number"></span> <span class="toc-text">不足之处</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Userspace"><span class="toc-number">0.0.1.</span> <span class="toc-text">Userspace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iptables"><span class="toc-number">0.0.2.</span> <span class="toc-text">iptables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPVS"><span class="toc-number">0.0.3.</span> <span class="toc-text">IPVS</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://www.buhuixiu.com/2021/11/08/service/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://www.buhuixiu.com/2021/11/08/service/&text=kubernetes_Service"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.buhuixiu.com/2021/11/08/service/&is_video=false&description=kubernetes_Service"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=kubernetes_Service&body=Check out this article: https://www.buhuixiu.com/2021/11/08/service/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://www.buhuixiu.com/2021/11/08/service/&title=kubernetes_Service"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://www.buhuixiu.com/2021/11/08/service/&name=kubernetes_Service&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://www.buhuixiu.com/2021/11/08/service/&t=kubernetes_Service"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-right">
    Copyright &copy;
    
    
    2016-2021
    Sampson.Z
<img src="https://www.buhuixiu.com/images/jgawb.png">
<a href="http://www.beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">粤ICP备19066509号</a>

  
  
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/zhuxinkai.site/">zhuxinkai.site</a></li>
        
      </ul>
    </nav>
  



        <!-- 不蒜子统计 -->
        <span id="busuanzi_container_site_pv">
                本站总访问量<span id="busuanzi_value_site_pv"></span>次
        </span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv" style='display:none'>
                本站访客数<span id="busuanzi_value_site_uv"></span>人
        </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

</div>


</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
